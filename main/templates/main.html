{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>House Of Champions</title>
{% endblock meta %}

{% block extra_head %}
<style>
  .decor-bg-home {
    position: fixed; inset: 0 0 auto 0; height: 36vh; z-index: -1;
    background-image: url('https://i.pinimg.com/1200x/44/24/62/44246235fc68567de2d96e63b642d6c6.jpg');
    background-size: cover; background-position: right top; opacity: .40;
    filter: saturate(.95) brightness(.95);
    transform: translateY(-6%);
  }
  
  @media (max-width: 768px) { 
    .decor-bg-home { background-position: center top; height: 24vh; } 
  }

  .loading-spinner {
    border: 3px solid #f3f4f6;
    border-top: 3px solid #10b981;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
{% endblock extra_head %}

{% block content %}
<!-- Background -->
<div class="decor-bg-home" aria-hidden="true"></div>

<!-- Main Container -->
<div class="min-h-screen bg-gray-50 dark:bg-slate-900">

  {% include 'navbar.html' %}

  <main class="pt-20 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-16">
    <!-- Header Section -->
    <section class="text-center mb-12">
      <h1 class="text-4xl sm:text-5xl font-bold text-slate-900 dark:text-white mb-4">
        House Of <span class="text-emerald-500">Champions</span>
      </h1>
      <p class="text-lg text-slate-600 dark:text-slate-300 max-w-2xl mx-auto mb-8">
        Discover premium football gear and exclusive merchandise
      </p>

      <!-- Action Buttons -->
      <div class="flex flex-wrap gap-4 justify-center mb-8">
        <button id="btn-create-modal" 
                class="px-6 py-3 bg-emerald-500 text-white rounded-lg font-semibold shadow hover:shadow-lg transition-all">
          ‚ûï Add Product
        </button>
        <button id="btn-refresh" 
                class="px-6 py-3 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 rounded-lg font-semibold shadow hover:shadow-lg transition-all">
          üîÑ Refresh
        </button>
        <a href="{% url 'main:create_products' %}" 
           class="px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold shadow hover:shadow-lg transition-all no-underline">
          üìÑ Full Page Form
        </a>
      </div>
    </section>

    <!-- Filters -->
    <section class="mb-8 text-center">
      <div class="inline-flex gap-2 bg-white/80 dark:bg-slate-800/60 p-2 rounded-lg shadow">
        <button data-filter="all" class="filter-btn px-4 py-2 rounded-md transition-all bg-emerald-500 text-white">
          All Products
        </button>
        <button data-filter="my" class="filter-btn px-4 py-2 rounded-md transition-all bg-transparent text-slate-700 dark:text-slate-200 hover:bg-gray-100 dark:hover:bg-slate-700">
          My Products
        </button>
      </div>
    </section>

    <!-- Status Indicators -->
    <div id="status-container" class="mb-8">
      <div id="loading-state" class="hidden text-center py-12">
        <div class="loading-spinner mb-4"></div>
        <p class="text-slate-600 dark:text-slate-300">Loading products...</p>
      </div>
      
      <div id="error-state" class="hidden text-center py-12">
        <div class="text-6xl mb-4">‚ùå</div>
        <h3 class="text-xl font-semibold mb-2">Failed to load products</h3>
        <p id="error-message" class="text-slate-600 dark:text-slate-300 mb-4"></p>
        <button id="retry-btn" class="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-all">
          Try Again
        </button>
      </div>
    </div>

    <!-- Products Container -->
    <div id="products-container">
      {% if not products_list %}
        <!-- Empty State -->
        <div class="text-center py-16 bg-white dark:bg-slate-800 rounded-2xl shadow">
          <div class="w-48 h-48 mx-auto mb-6">
            <img src="https://i.pinimg.com/originals/ab/c9/6f/abc96f284c5fd1a927380fe94b07a816.gif" 
                 alt="No products" 
                 class="w-full h-full object-contain">
          </div>
          <h3 class="text-2xl font-bold mb-4">Ready to Showcase? üèÜ</h3>
          <p class="text-slate-600 dark:text-slate-300 mb-2">Your product collection is empty</p>
          <p class="text-slate-500 dark:text-slate-400 mb-6">Start building your champion legacy by adding your first product!</p>
          <button id="btn-first-product" class="px-6 py-3 bg-emerald-500 text-white rounded-lg font-semibold shadow hover:shadow-lg transition-all">
            üöÄ Add Your First Product
          </button>
        </div>
      {% else %}
        <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {% for products in products_list %}
            {% include 'card_products.html' with products=products %}
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </main>
</div>

<!-- Toast Container -->
<div id="toast" class="fixed top-4 right-4 z-50 hidden">
  <div class="bg-gray-800 text-white px-6 py-4 rounded-lg shadow-lg">
    <div id="toast-message" class="font-semibold"></div>
  </div>
</div>

<!-- Modal Container -->
<div id="modal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/50" id="modal-backdrop"></div>
  <div class="relative z-10 flex items-center justify-center min-h-screen p-4">
    <div id="modal-content" class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
      <!-- Modal content will be loaded here -->
    </div>
  </div>
</div>

<script>
// ==================== CORE APPLICATION ====================
class ProductApp {
  constructor() {
    this.csrfToken = this.getCSRFToken();
    this.currentFilter = 'all';
    this.init();
  }

  init() {
    this.bindEvents();
    // Load products on initial page load
    this.loadProducts();
  }

  bindEvents() {
    // Action buttons
    document.getElementById('btn-create-modal')?.addEventListener('click', () => this.openCreateModal());
    document.getElementById('btn-refresh')?.addEventListener('click', () => this.loadProducts());
    document.getElementById('btn-first-product')?.addEventListener('click', () => this.openCreateModal());
    document.getElementById('retry-btn')?.addEventListener('click', () => this.loadProducts());

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => this.handleFilter(e.target.dataset.filter));
    });

    // Global event listeners
    document.addEventListener('click', (e) => this.handleGlobalClick(e));
    document.getElementById('modal-backdrop')?.addEventListener('click', () => this.hideModal());
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') this.hideModal();
    });
  }

  // ==================== PRODUCT MANAGEMENT ====================
  async loadProducts() {
    this.showLoading();
    // Also hide any error state from previous operations
    this.hideToast();
    
    try {
      const url = `{% url 'main:get_products_html' %}?filter=${this.currentFilter}`;
      const response = await fetch(url, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });

      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      
      const data = await response.json();
      
      if (data.success) {
        document.getElementById('products-container').innerHTML = data.html;
        this.hideStatus();
        // Don't show toast on initial load, only on manual refresh
        if (this.currentFilter) {
          this.showToast('Products refreshed successfully! üéâ', 'success');
        }
      } else {
        throw new Error(data.message || 'Failed to load products');
      }
    } catch (error) {
      this.showError(error.message);
    }
  }

  async openCreateModal() {
    try {
      const response = await fetch("{% url 'main:get_create_form' %}", {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      
      if (!response.ok) throw new Error('Failed to fetch form');
      
      const data = await response.json();
      if (data.success) {
        this.showModal(data.html);
      } else {
        throw new Error(data.message || 'Failed to load form');
      }
    } catch (error) {
      this.showToast('Failed to load form: ' + error.message, 'error');
    }
  }

  async handleFilter(filter) {
    this.currentFilter = filter;
    this.updateFilterButtons();
    await this.loadProducts();
  }

  // ==================== FORM HANDLING ====================
  async handleFormSubmit(form) {
    const formData = new FormData(form);
    // Convert FormData to a plain object, then to JSON
    const formObject = Object.fromEntries(formData.entries());
    // Convert 'is_featured' to a boolean
    if (formObject.is_featured) {
      formObject.is_featured = formObject.is_featured === 'on';
    }
    
    try {
      const response = await fetch(form.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': this.csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(formObject)
      });

      const data = await response.json();
      
      if (data.success) {
        this.hideModal();
        this.showToast(data.message || 'Operation completed successfully! üéâ', 'success');
        await this.loadProducts(); // Refresh the list
      } else {
        // Show validation errors from the server
        this.showToast(data.message || 'Please check the form for errors.', 'error');
      }
    } catch (error) {
      this.showToast('A network error occurred. Please try again.', 'error');
    }
  }

  async handleEdit(productId) {
    try {
      const response = await fetch(`{% url 'main:get_edit_form' '0' %}`.replace('0', productId), {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      
      if (!response.ok) throw new Error('Failed to fetch edit form');
      
      const data = await response.json();
      if (data.success) {
        this.showModal(data.html);
      } else {
        throw new Error(data.message || 'Failed to load edit form');
      }
    } catch (error) {
      this.showToast('Failed to load edit form: ' + error.message, 'error');
    }
  }

  async handleDeleteClick(productId) {
    try {
      const response = await fetch(`{% url 'main:get_delete_confirm' '0' %}`.replace('0', productId), {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      
      if (!response.ok) throw new Error('Failed to fetch delete confirmation');
      
      const data = await response.json();
      if (data.success) {
        this.showModal(data.html);
      } else {
        throw new Error(data.message || 'Failed to load confirmation dialog');
      }
    } catch (error) {
      this.showToast('Failed to load delete confirmation: ' + error.message, 'error');
    }
  }

  async confirmDelete(productId) {
    try {
      const response = await fetch(`{% url 'main:delete_products' '0' %}`.replace('0', productId), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': this.csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      const data = await response.json();
      
      if (data.success) {
        this.hideModal();
        this.showToast(data.message || 'Product deleted successfully!', 'success');
        await this.loadProducts(); // Refresh the list
      } else {
        this.showToast(data.message || 'Error deleting product', 'error');
      }
    } catch (error) {
      this.showToast('Network error occurred while deleting.', 'error');
    }
  }

  // ==================== AUTHENTICATION HANDLERS ====================
  async openLoginModal() {
    try {
      const response = await fetch("{% url 'main:get_login_form' %}", {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      
      const data = await response.json();
      if (data.success) {
        this.showModal(data.html);
      }
    } catch (error) {
      this.showToast('Failed to load login form', 'error');
    }
  }

  async openRegisterModal() {
    try {
      const response = await fetch("{% url 'main:get_register_form' %}", {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      
      const data = await response.json();
      if (data.success) {
        this.showModal(data.html);
      }
    } catch (error) {
      this.showToast('Failed to load registration form', 'error');
    }
  }

  async handleAuthFormSubmit(form, isLogin = true) {
    const formData = new FormData(form);
    const formObject = Object.fromEntries(formData.entries());
    
    try {
      const url = isLogin ? "{% url 'main:login_user' %}" : "{% url 'main:register' %}";
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': this.csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(formObject)
      });

      const data = await response.json();
      
      if (data.success) {
        this.hideModal();
        this.showToast(data.message || (isLogin ? 'Login successful! üéâ' : 'Registration successful! üéâ'), 'success');
        // Redirect or refresh page after successful auth
        if (data.redirect_url) {
          setTimeout(() => {
            window.location.href = data.redirect_url;
          }, 1500);
        }
      } else {
        this.showToast(data.message || `Authentication failed. Please try again.`, 'error');
      }
    } catch (error) {
      this.showToast('A network error occurred. Please try again.', 'error');
    }
  }

  async handleLogout() {
    try {
      const response = await fetch("{% url 'main:logout_user' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': this.csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      const data = await response.json();
      
      if (data.success) {
        this.showToast(data.message || 'Logged out successfully!', 'success');
        // Redirect to login page after logout
        if (data.redirect_url) {
          setTimeout(() => {
            window.location.href = data.redirect_url;
          }, 1500);
        }
      } else {
        this.showToast(data.message || 'Logout failed.', 'error');
      }
    } catch (error) {
      this.showToast('Network error during logout.', 'error');
    }
  }

  // ==================== UI CONTROLS ====================
  showModal(html) {
    document.getElementById('modal-content').innerHTML = html;
    document.getElementById('modal').classList.remove('hidden');
    // Prevent background scroll
    document.body.style.overflow = 'hidden';
  }

  hideModal() {
    document.getElementById('modal').classList.add('hidden');
    // Restore background scroll
    document.body.style.overflow = 'auto';
  }

  showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    
    // Set color and icon based on type
    const styles = {
      success: { bg: 'bg-green-500', icon: '‚úÖ' },
      error: { bg: 'bg-red-500', icon: '‚ùå' },
      info: { bg: 'bg-blue-500', icon: '‚ÑπÔ∏è' }
    };
    
    const style = styles[type] || styles.info;
    toast.className = `fixed top-4 right-4 z-50 ${style.bg} text-white px-6 py-4 rounded-lg shadow-lg transform transition-transform duration-300`;
    toastMessage.innerHTML = `${style.icon} ${message}`;
    toast.classList.remove('hidden');
    
    // Animate in
    setTimeout(() => {
      toast.style.transform = 'translateX(0)';
    }, 10);
    
    // Auto hide
    setTimeout(() => {
      this.hideToast();
    }, 5000);
  }

  hideToast() {
    const toast = document.getElementById('toast');
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => {
      toast.classList.add('hidden');
    }, 300);
  }

  showLoading() {
    this.hideStatus();
    document.getElementById('loading-state').classList.remove('hidden');
  }

  showError(message) {
    this.hideStatus();
    document.getElementById('error-state').classList.remove('hidden');
    document.getElementById('error-message').textContent = message;
  }

  hideStatus() {
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('error-state').classList.add('hidden');
  }

  updateFilterButtons() {
    document.querySelectorAll('.filter-btn').forEach(btn => {
      if (btn.dataset.filter === this.currentFilter) {
        btn.className = 'filter-btn px-4 py-2 rounded-md transition-all bg-emerald-500 text-white';
      } else {
        btn.className = 'filter-btn px-4 py-2 rounded-md transition-all bg-transparent text-slate-700 dark:text-slate-200 hover:bg-gray-100 dark:hover:bg-slate-700';
      }
    });
  }

  // ==================== EVENT HANDLING ====================
  handleGlobalClick(e) {
    const target = e.target;
    
    // Edit button
    if (target.closest('.edit-product-btn')) {
      e.preventDefault();
      const productId = target.closest('.edit-product-btn').dataset.id;
      this.handleEdit(productId);
    }
    
    // Delete button - opens confirmation modal
    if (target.closest('.delete-product-btn')) {
      e.preventDefault();
      const productId = target.closest('.delete-product-btn').dataset.id;
      this.handleDeleteClick(productId);
    }
    
    // Delete confirmation button in modal
    if (target.closest('.confirm-delete-btn')) {
      e.preventDefault();
      const productId = target.closest('.confirm-delete-btn').dataset.id;
      this.confirmDelete(productId);
    }
    
    // Form submission for products
    if (target.type === 'submit' && target.closest('#productsForm')) {
      e.preventDefault();
      this.handleFormSubmit(target.closest('#productsForm'));
    }
    
    // Login form submission
    if (target.type === 'submit' && target.closest('#loginForm')) {
      e.preventDefault();
      this.handleAuthFormSubmit(target.closest('#loginForm'), true);
    }
    
    // Register form submission
    if (target.type === 'submit' && target.closest('#registerForm')) {
      e.preventDefault();
      this.handleAuthFormSubmit(target.closest('#registerForm'), false);
    }
    
    // Cancel buttons
    if (target.closest('.cancel-btn')) {
      e.preventDefault();
      this.hideModal();
    }
    
    // Login button in navbar
    if (target.closest('#login-btn')) {
      e.preventDefault();
      this.openLoginModal();
    }
    
    // Register button in navbar
    if (target.closest('#register-btn')) {
      e.preventDefault();
      this.openRegisterModal();
    }
    
    // Logout button in navbar
    if (target.closest('#logout-btn')) {
      e.preventDefault();
      this.handleLogout();
    }
  }

  // ==================== UTILITIES ====================
  getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
  }
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
  window.productApp = new ProductApp();
});
</script>
{% endblock %}