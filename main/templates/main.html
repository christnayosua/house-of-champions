{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Football Products</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<!-- Include DOMPurify for sanitization -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

<div class="bg-gray-50 w-full pt-16 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header Section -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Football Products Store</h1>
      <p class="text-gray-600">Discover the best football gear and merchandise</p>
    </div>

    <!-- Action Buttons Section -->
    <div class="flex flex-wrap gap-3 mb-6">
      <!-- Refresh Button -->
      <button id="refresh-btn" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        Refresh Products
      </button>

      <!-- Create Products with AJAX Button -->
      <button onclick="openCreateProductModal()" class="inline-flex items-center px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition-colors">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Create Product with AJAX
      </button>

      <!-- Traditional Create Button (Fallback) -->
      <a href="{% url 'main:create_products' %}" class="inline-flex items-center px-4 py-2 bg-gray-600 text-white font-semibold rounded-md hover:bg-gray-700 transition-colors">
        Create Product (Traditional)
      </a>
    </div>

    <!-- Rest of your existing content remains the same -->
    <!-- Filter Section -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-white rounded-lg border border-gray-200 p-4">
      <div class="flex flex-wrap gap-3 mb-4 sm:mb-0">
        <button id="filter-all" class="bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-700">All Products</button>
        <button id="filter-my" class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white">My Products</button>
        
        <!-- Category Filter -->
        <select id="category-filter" class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
          <option value="">All Categories</option>
          <option value="jersey">Jerseys</option>
          <option value="boots">Football Boots</option>
          <option value="ball">Balls</option>
          <option value="accessory">Accessories</option>
          <option value="training">Training Gear</option>
        </select>

        <!-- Sort Options -->
        <select id="sort-options" class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
          <option value="-created_at">Newest First</option>
          <option value="created_at">Oldest First</option>
          <option value="name">Name A-Z</option>
          <option value="-name">Name Z-A</option>
          <option value="price">Price: Low to High</option>
          <option value="-price">Price: High to Low</option>
          <option value="-rating">Highest Rated</option>
          <option value="-visitors">Most Popular</option>
          <option value="-stock">Stock Terbanyak</option>
        </select>
      </div>

      <!-- Search Box -->
      <div class="relative">
        <input type="text" id="search-input" placeholder="Search products..." 
               class="border border-gray-300 rounded-md pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 w-full sm:w-64">
        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
    </div>

    <!-- Stats Section -->
    <div id="stats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 hidden">
      <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
        <div class="text-2xl font-bold text-green-600" id="total-products">0</div>
        <div class="text-gray-600 text-sm">Total Products</div>
      </div>
      <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
        <div class="text-2xl font-bold text-blue-600" id="my-products">0</div>
        <div class="text-gray-600 text-sm">My Products</div>
      </div>
      <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
        <div class="text-2xl font-bold text-yellow-600" id="featured-products">0</div>
        <div class="text-gray-600 text-sm">Featured</div>
      </div>
      <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
        <div class="text-2xl font-bold text-red-600" id="hot-products">0</div>
        <div class="text-gray-600 text-sm">Hot Products</div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center">
      <svg class="animate-spin h-8 w-8 text-green-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-gray-600 mt-3">Loading products...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden bg-red-50 border border-red-100 text-red-700 p-4 rounded-lg mb-4"></div>

    <!-- Products Grid -->
    <div id="grid" class="hidden"></div>

    <!-- Pagination -->
    <div id="pagination" class="hidden mt-8 flex justify-center items-center space-x-2"></div>

    <!-- Empty State -->
    <div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <div class="w-32 h-32 mx-auto mb-4">
        <img src="https://i.pinimg.com/originals/67/6e/05/676e05c6d065c7d504418085ea43c694.gif" alt="No products available" class="w-full h-full object-contain">
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
      <p class="text-gray-500 mb-6">Be the first to add football products to our store.</p>
      <button onclick="openCreateProductModal()" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
        Create Product
      </button>
    </div>
  </div>
</div>

<!-- AJAX Create Product Modal -->
<div id="createProductModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeCreateProductModal()"></div>

    <!-- Modal panel -->
    <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
      <div class="sm:flex sm:items-start">
        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
              Create New Product
            </h3>
            <button type="button" onclick="closeCreateProductModal()" class="text-gray-400 hover:text-gray-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <!-- Form will be loaded here -->
          <div id="createProductFormContainer">
            <div class="animate-pulse">
              <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
              <div class="h-10 bg-gray-200 rounded mb-4"></div>
              <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
              <div class="h-10 bg-gray-200 rounded mb-4"></div>
              <div class="h-4 bg-gray-200 rounded w-2/3 mb-4"></div>
              <div class="h-24 bg-gray-200 rounded mb-4"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Konfigurasi dan helper
   ========================= */
const PRODUCTS_API_ENDPOINT = "{% url 'main:show_main' %}";
const CREATE_PRODUCT_URL = "{% url 'main:create_products' %}";
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

// DOM Elements
const loadingSpinner = document.getElementById('loading');
const errorMessage = document.getElementById('error');
const emptyStateDisplay = document.getElementById('empty');
const newsGridContainer = document.getElementById('grid');
const paginationContainer = document.getElementById('pagination');
const statsContainer = document.getElementById('stats');
const refreshButton = document.getElementById('refresh-btn');
const createProductModal = document.getElementById('createProductModal');
const createProductFormContainer = document.getElementById('createProductFormContainer');

// Filter Elements
const showAllNewsButton = document.getElementById('filter-all');
const showMyNewsButton = document.getElementById('filter-my');
const categoryFilter = document.getElementById('category-filter');
const sortOptions = document.getElementById('sort-options');
const searchInput = document.getElementById('search-input');

// State Management
let activeFilter = 'all';
let currentPage = 1;
let totalPages = 1;
let allProductsData = [];
let searchTimeout = null;

// CSRF helper
function getCookie(name) {
  const v = document.cookie.split('; ').find(row => row.trim().startsWith(name + '='));
  return v ? decodeURIComponent(v.split('=')[1]) : null;
}
const csrftoken = getCookie('csrftoken');

// Sanitization helper
function sanitizeHtml(s) {
  return DOMPurify.sanitize(String(s || ''));
}

/* =========================
   Modal Functions untuk Create Product
   ========================= */

/**
 * Membuka modal untuk membuat produk baru
 * Memuat form create product via AJAX dari endpoint create_products
 */
async function openCreateProductModal() {
  try {
    // Tampilkan modal
    createProductModal.classList.remove('hidden');
    
    // Tampilkan loading state di dalam form container
    createProductFormContainer.innerHTML = `
      <div class="animate-pulse">
        <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
        <div class="h-10 bg-gray-200 rounded mb-4"></div>
        <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
        <div class="h-10 bg-gray-200 rounded mb-4"></div>
        <div class="h-4 bg-gray-200 rounded w-2/3 mb-4"></div>
        <div class="h-24 bg-gray-200 rounded mb-4"></div>
      </div>
    `;

    // Load form create product via AJAX
    const response = await fetch(CREATE_PRODUCT_URL, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error('Failed to load create form');
    }

    const data = await response.json();
    
    if (data.form_html) {
      // Render form HTML yang diterima dari server
      createProductFormContainer.innerHTML = data.form_html;
      
      // Bind form submission handler
      const form = createProductFormContainer.querySelector('form');
      if (form) {
        bindCreateFormSubmission(form);
      }
    } else {
      throw new Error('No form HTML received');
    }
  } catch (error) {
    console.error('Error loading create form:', error);
    createProductFormContainer.innerHTML = `
      <div class="bg-red-50 border border-red-200 rounded-md p-4">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
            </svg>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800">Error loading form</h3>
            <div class="mt-2 text-sm text-red-700">
              <p>Unable to load the create product form. Please try again.</p>
            </div>
          </div>
        </div>
      </div>
    `;
  }
}

/**
 * Menutup modal create product dan reset form
 */
function closeCreateProductModal() {
  createProductModal.classList.add('hidden');
  // Clear form container untuk next load
  createProductFormContainer.innerHTML = '';
}

/**
 * Bind form submission handler untuk form create product
 * @param {HTMLFormElement} form - Form element yang akan di-bind
 */
function bindCreateFormSubmission(form) {
  form.addEventListener('submit', async function(event) {
    event.preventDefault();
    
    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    
    // Tampilkan loading state di button
    submitButton.disabled = true;
    submitButton.innerHTML = `
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      Creating...
    `;

    try {
      const formData = new FormData(form);
      
      const response = await fetch(CREATE_PRODUCT_URL, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrftoken,
        },
        body: formData
      });

      const data = await response.json();

      if (data.status === 'success') {
        // Success case
        showToast('Success', data.message || 'Product created successfully!', 'success');
        closeCreateProductModal();
        
        // Refresh products list
        fetchProductsFromServer(1);
        
        // Dispatch custom event untuk update lainnya
        document.dispatchEvent(new CustomEvent('productCreated', { 
          detail: { product: data.product } 
        }));
      } else {
        // Error case - tampilkan error di form
        displayFormErrors(form, data.errors || {});
        showToast('Error', data.message || 'Failed to create product', 'error');
      }
    } catch (error) {
      console.error('Error creating product:', error);
      showToast('Error', 'Network error while creating product', 'error');
    } finally {
      // Restore button state
      submitButton.disabled = false;
      submitButton.textContent = originalText;
    }
  });
}

/**
 * Menampilkan error validasi form
 * @param {HTMLFormElement} form - Form element
 * @param {Object} errors - Object errors dari response
 */
function displayFormErrors(form, errors) {
  // Clear previous errors
  form.querySelectorAll('.error-message').forEach(el => el.remove());
  form.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
  
  // Display new errors
  for (const [field, fieldErrors] of Object.entries(errors)) {
    const input = form.querySelector(`[name="${field}"]`);
    if (input) {
      // Highlight input dengan error
      input.classList.add('border-red-500');
      
      // Tambahkan error message
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message text-red-600 text-sm mt-1';
      errorDiv.innerHTML = fieldErrors.map(error => 
        `<p>${sanitizeHtml(error.message)}</p>`
      ).join('');
      
      input.parentNode.appendChild(errorDiv);
    }
  }
  
  // Handle non-field errors
  if (errors.__all__) {
    const generalErrorDiv = document.createElement('div');
    generalErrorDiv.className = 'error-message bg-red-50 border border-red-200 rounded-md p-4 mb-4';
    generalErrorDiv.innerHTML = errors.__all__.map(error => 
      `<p class="text-red-800">${sanitizeHtml(error.message)}</p>`
    ).join('');
    
    form.prepend(generalErrorDiv);
  }
}

/* =========================
   UI State Management
   ========================= */
function updateFilterButtonsAppearance() {
  if (!showAllNewsButton || !showMyNewsButton) return;
  if (activeFilter === 'all') {
    showAllNewsButton.className = 'bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-700';
    showMyNewsButton.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white';
  } else {
    showMyNewsButton.className = 'bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-700';
    showAllNewsButton.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white';
  }
}

function displayPageSection({ showLoading=false, showError=false, showEmpty=false, showGrid=false, errorText='' } = {}) {
  loadingSpinner.classList.toggle('hidden', !showLoading);
  errorMessage.classList.toggle('hidden', !showError);
  emptyStateDisplay.classList.toggle('hidden', !showEmpty);
  newsGridContainer.classList.toggle('hidden', !showGrid);
  paginationContainer.classList.toggle('hidden', !showGrid);
  statsContainer.classList.toggle('hidden', !showGrid);

  if (showError) {
    errorMessage.textContent = errorText || 'Error loading products. Please try again.';
  } else {
    errorMessage.textContent = '';
  }

  if (showGrid) {
    newsGridContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6';
  }
}

/* =========================
   Product Card Builder
   ========================= */
function buildProductCardElement(item) {
  const article = document.createElement('article');
  article.className = 'bg-white rounded-lg border border-gray-200 hover:shadow-lg transition-all duration-300 overflow-hidden flex flex-col h-full';

  const detailUrl = item.detail_url;
  const editUrl = `{% url 'main:edit_products' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);
  const deleteUrl = `{% url 'main:delete_products' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);

  const title = sanitizeHtml(item.name);
  const description = sanitizeHtml(item.description);
  const category = sanitizeHtml(item.category);
  const brand = sanitizeHtml(item.brandName);
  const thumbnail = sanitizeHtml(item.thumbnail1);
  const price = item.formatted_price || `Rp ${parseInt(item.price || 0).toLocaleString('id-ID')}`;
  const priceUSD = item.price_usd || `$${(parseInt(item.price || 0) / 15000).toFixed(2)}`;
  const rating = item.rating || 0;
  const stock = item.stock || 0;
  const createdAt = item.created_at;
  const visitors = item.visitors || 0;
  const isFeatured = item.is_featured;
  const isHot = item.is_products_hot;
  const canEdit = item.can_edit;
  const canDelete = item.can_delete;

  const thumbnailHtml = thumbnail ? 
    `<img src="${thumbnail}" alt="${title}" class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-105">` : 
    `<div class="w-full h-48 bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center text-gray-400">
      <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
      </svg>
    </div>`;

  const categoryLabel = getReadableCategoryName(category);
  const featuredLabel = isFeatured ? `<span class='inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800'>Featured</span>` : '';
  const hotLabel = isHot ? `<span class='inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800'>Hot</span>` : '';
  const stockLabel = stock > 0 ? 
    `<span class='inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800'>${stock} in stock</span>` :
    `<span class='inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800'>Out of stock</span>`;

  const ratingStars = generateRatingStars(rating);

  const editDeleteHtml = canEdit ? `
    <div class="flex items-center gap-3 mt-3 pt-3 border-t border-gray-100">
      <button class="text-blue-600 hover:text-blue-800 text-sm font-medium transition-colors" onclick="openEditModal('${editUrl}')">Edit</button>
      <button class="text-red-600 hover:text-red-800 text-sm font-medium transition-colors" onclick="deleteProduct('${item.id}')">Delete</button>
    </div>
  ` : '';

  const cardHtml = `
    <div class="group relative">
      ${thumbnailHtml}
      <div class="absolute top-3 left-3 flex flex-col gap-1">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-green-600 text-white">${categoryLabel}</span>
        ${featuredLabel}
      </div>
      <div class="absolute top-3 right-3 flex flex-col gap-1">
        ${hotLabel}
        ${stockLabel}
      </div>
    </div>
    <div class="p-4 flex flex-col flex-1">
      <div class="flex items-start justify-between mb-2">
        <h3 class="text-lg font-semibold text-gray-900 line-clamp-2 flex-1 mr-2">
          <a href="${detailUrl}" class="hover:text-green-600 transition-colors">${title}</a>
        </h3>
      </div>
      
      <p class="text-gray-600 text-sm mb-3 line-clamp-2">${description}</p>
      
      <div class="flex items-center text-sm text-gray-500 mb-3">
        <span class="text-yellow-500 mr-1">${ratingStars}</span>
        <span class="mx-1">•</span>
        <span>${visitors} views</span>
      </div>
      
      <div class="mt-auto">
        <div class="flex items-center justify-between mb-2">
          <div class="text-lg font-bold text-green-600">${price}</div>
          <div class="text-sm text-gray-500">${priceUSD}</div>
        </div>
        <div class="text-xs text-gray-500 mb-2">by ${brand}</div>
        <div class="text-xs text-gray-400">Added ${createdAt}</div>
      </div>
      ${editDeleteHtml}
    </div>
  `;

  article.innerHTML = cardHtml;
  return article;
}

function generateRatingStars(rating) {
  const fullStars = Math.floor(rating);
  const hasHalfStar = rating % 1 >= 0.5;
  const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
  
  let stars = '';
  for (let i = 0; i < fullStars; i++) {
    stars += '★';
  }
  if (hasHalfStar) {
    stars += '½';
  }
  for (let i = 0; i < emptyStars; i++) {
    stars += '☆';
  }
  return stars;
}

/* =========================
   Data Fetching & Rendering
   ========================= */
async function fetchProductsFromServer(page = 1) {
  try {
    displayPageSection({ showLoading: true });

    const params = new URLSearchParams({
      page: page,
      per_page: 12,
      filter: activeFilter,
      sort: sortOptions.value
    });

    if (categoryFilter.value) {
      params.append('category', categoryFilter.value);
    }

    if (searchInput.value) {
      params.append('search', searchInput.value);
    }

    const url = `${PRODUCTS_API_ENDPOINT}?${params.toString()}`;
    const res = await fetch(url, {
      headers: { 
        'Accept': 'application/json', 
        'X-Requested-With': 'XMLHttpRequest' 
      }
    });

    if (!res.ok) throw new Error('Failed to fetch products data from server');

    const data = await res.json();
    
    if (data.status === 'success') {
      allProductsData = data.products;
      currentPage = data.current_page;
      totalPages = data.total_pages;
      
      updateStats(data);
      renderProducts();
      renderPagination();
    } else {
      throw new Error(data.message || 'Failed to load products');
    }
  } catch (err) {
    console.error('Error loading products:', err);
    displayPageSection({ 
      showError: true, 
      errorText: 'Failed to load products. Please try again.' 
    });
  }
}

function renderProducts() {
  newsGridContainer.innerHTML = '';
  
  if (!allProductsData || allProductsData.length === 0) {
    displayPageSection({ showEmpty: true });
    return;
  }

  allProductsData.forEach(product => {
    const cardElement = buildProductCardElement(product);
    newsGridContainer.appendChild(cardElement);
  });

  displayPageSection({ showGrid: true });
}

function renderPagination() {
  if (totalPages <= 1) {
    paginationContainer.classList.add('hidden');
    return;
  }

  let paginationHtml = '';
  
  // Previous button
  if (currentPage > 1) {
    paginationHtml += `
      <button onclick="fetchProductsFromServer(${currentPage - 1})" 
              class="px-3 py-2 rounded border border-gray-300 hover:bg-gray-50 transition-colors">
        Previous
      </button>
    `;
  }

  // Page numbers
  for (let i = 1; i <= totalPages; i++) {
    if (i === currentPage) {
      paginationHtml += `
        <span class="px-3 py-2 rounded bg-green-600 text-white border border-green-600">
          ${i}
        </span>
      `;
    } else {
      paginationHtml += `
        <button onclick="fetchProductsFromServer(${i})" 
                class="px-3 py-2 rounded border border-gray-300 hover:bg-gray-50 transition-colors">
          ${i}
        </button>
      `;
    }
  }

  // Next button
  if (currentPage < totalPages) {
    paginationHtml += `
      <button onclick="fetchProductsFromServer(${currentPage + 1})" 
              class="px-3 py-2 rounded border border-gray-300 hover:bg-gray-50 transition-colors">
        Next
      </button>
    `;
  }

  paginationContainer.innerHTML = paginationHtml;
  paginationContainer.classList.remove('hidden');
}

function updateStats(data) {
  document.getElementById('total-products').textContent = data.total_products || 0;
  document.getElementById('my-products').textContent = allProductsData.filter(p => p.can_edit).length;
  document.getElementById('featured-products').textContent = allProductsData.filter(p => p.is_featured).length;
  document.getElementById('hot-products').textContent = allProductsData.filter(p => p.is_products_hot).length;
}

/* =========================
   CRUD Operations
   ========================= */
async function deleteProduct(id) {
  if (!confirm('Are you sure you want to delete this product?')) return;
  
  const deleteUrl = `{% url 'main:delete_products' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', id);

  try {
    const res = await fetch(deleteUrl, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': csrftoken,
      },
    });
    
    const data = await res.json();
    
    if (data.status === 'success') {
      showToast('Success', data.message || 'Product deleted successfully', 'success');
      fetchProductsFromServer(currentPage);
    } else {
      showToast('Error', data.message || 'Failed to delete product', 'error');
    }
  } catch (err) {
    console.error('Delete error', err);
    showToast('Error', 'Network error while deleting product', 'error');
  }
}

/* =========================
   Utility Functions
   ========================= */
function getReadableCategoryName(code) {
  const categoryMap = {
    'jersey': 'Jersey',
    'boots': 'Football Boots',
    'ball': 'Football',
    'accessory': 'Accessory',
    'training': 'Training Gear',
    'jerseys': 'Jersey',
    'football-boots': 'Football Boots',
    'football-balls': 'Football',
    'accessories': 'Accessory',
    'training-gear': 'Training Gear'
  };
  return categoryMap[code] || code;
}

function showToast(title, message, type = 'info') {
  // Simple toast notification implementation
  const toast = document.createElement('div');
  toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
    type === 'success' ? 'bg-green-500 text-white' :
    type === 'error' ? 'bg-red-500 text-white' :
    'bg-blue-500 text-white'
  }`;
  toast.innerHTML = `
    <div class="font-semibold">${title}</div>
    <div class="text-sm">${message}</div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 3000);
}

/* =========================
   Event Handlers & Initialization
   ========================= */
function handleSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    fetchProductsFromServer(1);
  }, 500);
}

function handleFilterChange() {
  fetchProductsFromServer(1);
}

document.addEventListener('DOMContentLoaded', () => {
  // Event listeners for filters
  if (showAllNewsButton) showAllNewsButton.addEventListener('click', () => {
    activeFilter = 'all';
    updateFilterButtonsAppearance();
    fetchProductsFromServer(1);
  });
  
  if (showMyNewsButton) showMyNewsButton.addEventListener('click', () => {
    activeFilter = 'my_products';
    updateFilterButtonsAppearance();
    fetchProductsFromServer(1);
  });

  if (categoryFilter) categoryFilter.addEventListener('change', handleFilterChange);
  if (sortOptions) sortOptions.addEventListener('change', handleFilterChange);
  if (searchInput) searchInput.addEventListener('input', handleSearch);
  if (refreshButton) refreshButton.addEventListener('click', () => fetchProductsFromServer(1));

  // Load initial data
  fetchProductsFromServer(1);
  updateFilterButtonsAppearance();
});

// Global event for product updates
document.addEventListener('productCreated', () => {
  fetchProductsFromServer(currentPage);
});
</script>

{% endblock content %}